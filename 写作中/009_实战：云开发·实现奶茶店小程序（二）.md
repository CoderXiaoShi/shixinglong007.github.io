> 2020-5-6

文章编号：009/100

以前很少写文章。从今天开始我要挑战一下自己，连续输出100篇技术类文章。这100篇文章我尽量以实战案例为主。

如果你觉得本文还不错，记得关注或者给个 star，你们的赞和star是我编写更多更精彩文章的动力！
[GitHub 地址](https://github.com/shixinglong007/shixinglong007.github.io/)

私人公众号：程序员小石

---

## 正文

上一篇文章简单分析了“奶茶店·小程序”，现在我们先来实现接口和数据库。

- 第一篇：业务逻辑拆分，敲定设计稿，设计 API 和数据库
- **第二篇：完成接口开发，测试接口**
- 第三篇：完成前端页面，联调接口

## 本文重点内容
* Taro 构建小程序
* 云函数设计
* 云函数 + 云数据库实现：队列推送

## 云函数

![](/access/009/demo_009_1.png)

## Taro 构建小程序

**windows 系统要安装 python**，Nodejs版本要 >=8.0.0

尽量使用Taro 最新版，微信更新的很快。Taro 也会及时跟进

我目前的Taro 版本是 v2.2.3

构建项目
![](/access/009/demo_009_02.gif)

## 云函数设计

一般一个云函数负责一个模块，比如 Tea， 只负责 Tea 的 CURD 操作。

我的云函数需要两个字段 action 和 params。

其中 action 标记动作，params 是参数。这样设计云函数能提高可扩展性。

```javascript
// 云函数入口文件
const cloud = require('wx-server-sdk')
const method = require('./method');
cloud.init({ env: 'xxx'})

const db = cloud.database();

exports.db = db

// 云函数入口函数
exports.main = async (event, context) => {
  // 接受两个参数
  const { action, params } = event
  let res = {}
  switch(action) {
    case 'create':  // 增
      res = await method.create(params);
    break;
    case 'del':// 删
      res = await method.del(params);
    break;
    case 'update':// 改
      res = await method.update(params);
    break;
    case 'select':// 查
      res = await method.select(params);
    break;
  }
  return res
}
```
前端代码

```javascript
// 新增
let res = await Taro.cloud.callFunction({
    name: 'tea',
    data: {
        action: 'create',
        params: {
            name: '红茶玛奇朵',
            price: '18.00',
            description: '红茶与奶油的美妙结合....',
            imgs: [...],
            selects: [...]
        }
    }
})
// 删除
let res = await Taro.cloud.callFunction({
    name: 'tea',
    data: {
        action: 'del',
        params: {
            '_id': 'xxx'
        }
    }
})
```

这样实现代码可读性强，容易扩展。

其他的云函数我就不一一列举了,大部分都是增删改查的操作。 [代码传送门]()

## 云函数 + 云数据库实现：队列推送

排队功能是刚需，必须要求实时更新。这里借助云数据库的.watch()功能

## 最后

下一篇文章：完成前端页面，联调接口

![](/access/web_access_2.png)
